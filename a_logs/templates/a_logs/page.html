{% extends 'a_incidents/base.html' %}

{% block content %}
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">System Logs</h1>
        
        <!-- Messages Section -->
        {% if messages %}
            <div class="mb-6 space-y-2">
                {% for message in messages %}
                    <div class="p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300{% elif message.tags == 'success' %}bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300{% else %}bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300{% endif %}">
                        <p class="text-sm font-medium">{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        <!-- Filter Section -->
        <div class="mb-6 bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Filter Logs</h2>
            <form method="GET" action="">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    {% for field in filter.form %}  <!-- This accesses the form inside the filterset -->
                        <div>
                            <label for="{{ field.id_for_label }}" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                {{ field.label }}
                            </label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                
                <div class="flex gap-2">
                    <button type="submit"
                            class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700">
                        Apply Filters
                    </button>
                    {% if filters_applied %}
                    <a href="{% url 'logs' %}"
                       class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700">
                        Clear Filters
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
                
        <!-- Table Section -->
        <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
            <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                    <tr>
                        <th scope="col" class="px-6 py-3">
                            Timestamp
                        </th>
                        <th scope="col" class="px-6 py-3">
                            User
                        </th>
                        <th scope="col" class="px-6 py-3">
                            Action
                        </th>
                        <th scope="col" class="px-6 py-3">
                            Object
                        </th>
                        <th scope="col" class="px-6 py-3">
                            Changes
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                            {{ log.action_time|date:"Y-m-d H:i:s" }}
                        </th>
                        <td class="px-6 py-4">
                            {{ log.user.username|default:"System" }}
                        </td>
                        <td class="px-6 py-4">
                            {% if log.action_flag == 1 %}
                                <span class="inline-flex items-center bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-green-900 dark:text-green-300">
                                    <span class="w-2 h-2 me-1 bg-green-500 rounded-full"></span>
                                    Added
                                </span>
                            {% elif log.action_flag == 2 %}
                                <span class="inline-flex items-center bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-blue-900 dark:text-blue-300">
                                    <span class="w-2 h-2 me-1 bg-blue-500 rounded-full"></span>
                                    Changed
                                </span>
                            {% elif log.action_flag == 3 %}
                                <span class="inline-flex items-center bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-red-900 dark:text-red-300">
                                    <span class="w-2 h-2 me-1 bg-red-500 rounded-full"></span>
                                    Deleted
                                </span>
                            {% else %}
                                <span class="text-gray-500">Unknown</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            {{ log.content_type.name|capfirst }}: {{ log.object_repr|truncatechars:50 }}
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-gray-600 dark:text-gray-400">{{ log.change_message|truncatechars:100 }}</span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr class="bg-white dark:bg-gray-800">
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            No logs found
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <p class="mt-4 text-sm text-gray-500 dark:text-gray-400">
            Showing up to 100 most recent logs
        </p>
    </div>
{% endblock %}